#!/usr/bin/env python3
"""Preview the conversation in a Claude session JSONL file.
Called by fzf --preview in the claude+ session browser.
Argument: path to a .jsonl session file.
"""
import sys, json, os
from datetime import datetime, timezone

BOLD   = '\033[1m'
DIM    = '\033[2m'
CYAN   = '\033[1;36m'
YELLOW = '\033[0;33m'
GREEN  = '\033[0;32m'
RESET  = '\033[0m'

session_file = sys.argv[1] if len(sys.argv) > 1 else ""
if not session_file or not os.path.isfile(session_file):
    print(f"{DIM}(no session file){RESET}")
    sys.exit(0)

size  = os.path.getsize(session_file)
mtime = os.path.getmtime(session_file)
dt    = datetime.fromtimestamp(mtime, tz=timezone.utc)

print(f"{DIM}{dt.strftime('%Y-%m-%d %H:%M UTC')}  {size // 1024}KB{RESET}")
print()

messages = []
try:
    with open(session_file, errors='replace') as f:
        for i, line in enumerate(f):
            if i > 10000:
                break
            try:
                d    = json.loads(line)
                msg  = d.get('message', {})
                role = msg.get('role', '')
                if role not in ('user', 'assistant'):
                    continue
                content = msg.get('content', '')
                text = ''
                if isinstance(content, list):
                    for c in content:
                        if isinstance(c, dict) and c.get('type') == 'text':
                            text = c['text'].strip()
                            break
                elif isinstance(content, str):
                    text = content.strip()
                if text:
                    messages.append((role, text))
            except Exception:
                pass
except Exception as e:
    print(f"Error reading session: {e}")
    sys.exit(1)

if not messages:
    print(f"{DIM}(no readable messages){RESET}")
    sys.exit(0)

print(f"{DIM}{len(messages)} messages{RESET}")
print()

def show_msg(role, text):
    if role == 'user':
        first_line = text.split('\n')[0][:110]
        print(f"{CYAN}{BOLD}❯ {first_line}{RESET}")
        if len(text) > len(first_line):
            rest = text[len(first_line):].strip()[:120].replace('\n', ' ')
            if rest:
                print(f"  {DIM}{rest}{'…' if len(text) > len(first_line) + 120 else ''}{RESET}")
    else:
        snippet = text.replace('\n', ' ')[:100]
        print(f"  {DIM}↳ {snippet}{'…' if len(text) > 100 else ''}{RESET}")
    print()

# Show first 10 exchanges + last 3 if long
MAX_SHOW = 12
if len(messages) <= MAX_SHOW:
    for role, text in messages:
        show_msg(role, text)
else:
    for role, text in messages[:8]:
        show_msg(role, text)
    print(f"{DIM}  ··· {len(messages) - 10} messages omitted ···{RESET}")
    print()
    for role, text in messages[-3:]:
        show_msg(role, text)
